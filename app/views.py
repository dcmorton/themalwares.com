from app import app
from pymongo import MongoClient
from flask import render_template, flash, redirect
from .forms import md5search

MONGO_IP = 'mustang.thenullroute.net'
MONGO_PORT = '27017'
MONGO_DB = 'malware'
MONGO_COLLECTION = 'samples'

client = MongoClient("mongodb://"+MONGO_IP+":"+MONGO_PORT)
collection = client[MONGO_DB][MONGO_COLLECTION]

@app.route('/')
@app.route('/index')
def index():
	uniq_samples = collection.count()
	uniq_samples = "{:,}".format(uniq_samples)
	return render_template("index.html", data=uniq_samples)

@app.route('/search', methods=['GET', 'POST'])
def search():
    form = md5search()
    if form.validate_on_submit():
    	for item in collection.find({'results.md5':form.md5query.data},{'_id': False, 'response_code': False, 'results.response_code': False, 'results.verbose_msg': False, 'results.scans': False}):
    		flash(item)
    		return redirect('/results')
    	flash("Sample not found")
    	return redirect('/results')
    return render_template('search.html', 
                           title='Search',
                           form=form)

@app.route('/results')
def results():
	return render_template('results.html', title='Results')